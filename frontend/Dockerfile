FROM node:18-alpine as build

WORKDIR /app

# 複製 package 文件
COPY package*.json ./

# 安裝依賴
RUN npm install

# 複製源代碼
COPY . .

# 設置構建時環境變數（如果未提供，使用默認值）
ARG VITE_API_BASE_URL=/api/v1
ENV VITE_API_BASE_URL=$VITE_API_BASE_URL

# 功能開關配置（預設值為 true，保持向後兼容）
ARG VITE_FEATURE_BATCH_SEAL_ADJUSTMENT=true
ENV VITE_FEATURE_BATCH_SEAL_ADJUSTMENT=$VITE_FEATURE_BATCH_SEAL_ADJUSTMENT

ARG VITE_FEATURE_METRICS_EXPLANATION_DIALOG=true
ENV VITE_FEATURE_METRICS_EXPLANATION_DIALOG=$VITE_FEATURE_METRICS_EXPLANATION_DIALOG

ARG VITE_FEATURE_SIMILARITY_HISTOGRAM=true
ENV VITE_FEATURE_SIMILARITY_HISTOGRAM=$VITE_FEATURE_SIMILARITY_HISTOGRAM

ARG VITE_FEATURE_COMPARISON_EDIT_DIALOG=true
ENV VITE_FEATURE_COMPARISON_EDIT_DIALOG=$VITE_FEATURE_COMPARISON_EDIT_DIALOG

ARG VITE_FEATURE_DELETE_CONFIRM_DIALOG=true
ENV VITE_FEATURE_DELETE_CONFIRM_DIALOG=$VITE_FEATURE_DELETE_CONFIRM_DIALOG

ARG VITE_FEATURE_PROCESSING_STAGES=true
ENV VITE_FEATURE_PROCESSING_STAGES=$VITE_FEATURE_PROCESSING_STAGES

ARG VITE_FEATURE_VERIFICATION_VIEW=true
ENV VITE_FEATURE_VERIFICATION_VIEW=$VITE_FEATURE_VERIFICATION_VIEW

ARG VITE_FEATURE_IMAGE_MODAL=true
ENV VITE_FEATURE_IMAGE_MODAL=$VITE_FEATURE_IMAGE_MODAL

ARG VITE_FEATURE_IMAGE_PREVIEW_DIALOG=true
ENV VITE_FEATURE_IMAGE_PREVIEW_DIALOG=$VITE_FEATURE_IMAGE_PREVIEW_DIALOG

# UI 元素開關配置（預設值為 true，保持向後兼容）
ARG VITE_FEATURE_MASK_STATISTICS=true
ENV VITE_FEATURE_MASK_STATISTICS=$VITE_FEATURE_MASK_STATISTICS

ARG VITE_FEATURE_TIMING_DETAILS=true
ENV VITE_FEATURE_TIMING_DETAILS=$VITE_FEATURE_TIMING_DETAILS

ARG VITE_FEATURE_TASK_TIMING_STATISTICS=true
ENV VITE_FEATURE_TASK_TIMING_STATISTICS=$VITE_FEATURE_TASK_TIMING_STATISTICS

ARG VITE_FEATURE_ADVANCED_SETTINGS=true
ENV VITE_FEATURE_ADVANCED_SETTINGS=$VITE_FEATURE_ADVANCED_SETTINGS

ARG VITE_FEATURE_MAX_SEALS_SETTING=true
ENV VITE_FEATURE_MAX_SEALS_SETTING=$VITE_FEATURE_MAX_SEALS_SETTING

ARG VITE_FEATURE_THRESHOLD_SETTING=true
ENV VITE_FEATURE_THRESHOLD_SETTING=$VITE_FEATURE_THRESHOLD_SETTING

ARG VITE_FEATURE_MASK_WEIGHTS_SETTING=true
ENV VITE_FEATURE_MASK_WEIGHTS_SETTING=$VITE_FEATURE_MASK_WEIGHTS_SETTING

ARG VITE_FEATURE_ALIGNMENT_TIMING_DETAILS=true
ENV VITE_FEATURE_ALIGNMENT_TIMING_DETAILS=$VITE_FEATURE_ALIGNMENT_TIMING_DETAILS

# 構建應用
RUN npm run build

# 生產環境
FROM nginx:alpine

# 複製構建結果
COPY --from=build /app/dist /usr/share/nginx/html

# 複製 nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]

