# 印鑑圖像比對流程圖說明

## 概述

此 SVG 流程圖詳細展示了印鑑圖像比對系統的完整流程，包含每個步驟的：
- **INPUT**: 輸入數據
- **PROCESS**: 處理過程
- **OUTPUT**: 輸出結果

## 流程階段說明

### 階段1: API接收請求與初始化
- **輸入**: image1_id, image2_id, threshold
- **處理**: 驗證圖像存在，創建比對記錄
- **輸出**: Comparison記錄（status=PENDING），觸發後台任務

### 階段2: 載入與驗證圖像
- **輸入**: 圖像文件路徑、bbox信息
- **處理**: 驗證文件存在、讀取圖像、驗證格式
- **輸出**: 原始圖像陣列（img1_original, img2_original）

### 階段3: 裁切圖像（如果有bbox）
- **輸入**: 原始圖像、bbox座標
- **處理**: 檢查bbox有效性、執行裁切、邊界檢查
- **輸出**: 裁切後的圖像（如果無bbox則使用原圖）

### 階段4: 自動偵測邊界並移除背景
- **輸入**: 裁切後的圖像
- **處理**: 
  - 檢測邊緣背景顏色
  - OTSU二值化
  - 輪廓檢測+自動裁切
- **輸出**: 去背景後的圖像（背景設為白色255）

### 階段5: 對齊圖像1（基本對齊）
- **輸入**: 去背景後的圖像1
- **處理**: 
  - 平移：印章中心對齊到圖片中心
  - 檢測形狀（方形/圓形）
  - 旋轉：方形→邊緣水平，圓形→文字正視
- **輸出**: 對齊後的圖像1、旋轉角度、平移偏移

### 階段6: 對齊圖像2（相對於圖像1優化）
- **輸入**: 去背景後的圖像2、對齊後的圖像1（作為參考）
- **處理**: 
  - **階段1**: 粗搜索（縮小圖像30%，角度±45°每5°，平移±100px每10px）
  - **階段2**: 細搜索（±2°，±10px）
  - **階段3**: 評估相似度
- **輸出**: 對齊後的圖像2、最佳旋轉角度、最佳平移偏移、對齊相似度

⚠️ **潛在問題**:
- 粗搜索範圍可能不夠大（±45°可能不足）
- 縮小圖像可能損失細節（30%可能太小）
- 搜索步長可能不夠細（5°、10px可能太粗）
- 沒有迭代優化機制（只搜索一次）
- 相似度評估方法可能不夠準確
- 沒有考慮尺度變化（只有旋轉+平移）

### 階段7: 計算相似度指標
- **輸入**: 對齊後的兩個圖像
- **處理**: 
  - 計算多種相似度指標：
    1. SSIM（結構相似性）
    2. Template Match（模板匹配）
    3. Pixel Similarity（像素相似度）
    4. Histogram Similarity（直方圖相似度）
    5. Edge Similarity（邊緣相似度）
    6. Exact Match Ratio（精確匹配率）
    7. MSE Similarity（均方誤差相似度）
  - 加權組合計算最終相似度
- **輸出**: 最終相似度（0.0-1.0）、是否匹配（is_match）

⚠️ **潛在問題**:
- 權重分配可能不合理（Edge只有5%可能太低）
- 沒有考慮圖像品質差異
- 特殊情況處理複雜（exact_match_ratio > 0.95時）
- 沒有考慮局部相似度
- 閾值固定(0.95)可能不適用所有情況

### 階段8: 生成視覺化圖表
- **輸入**: 對齊後的圖像、旋轉角度、平移偏移
- **處理**: 
  1. **並排對比圖**: 三圖並排顯示（參考/原始/校正後）
  2. **差異熱力圖**: 計算像素差異，使用JET顏色映射
  3. **疊圖**: 移除背景、創建透明圖像、計算差異區域、綠色標記差異
- **輸出**: comparison_image.jpg、heatmap_image.jpg、overlay1.png、overlay2.png

⚠️ **潛在問題**:
- 疊圖的背景移除可能不準確（邊緣檢測方法簡單）
- 差異閾值固定(30)可能不適用所有圖像
- 熱力圖的高斯模糊參數固定(15x15)
- 沒有考慮顏色空間轉換的一致性
- PNG壓縮級別固定(1)，可能檔案過大
- 視覺化生成失敗時沒有重試機制
- 沒有提供視覺化的品質指標

### 階段9: 保存結果並完成
- **輸入**: 所有計算結果、視覺化文件路徑
- **處理**: 更新資料庫記錄
- **輸出**: 完整的Comparison記錄（status=COMPLETED）

## 如何查看流程圖

1. **瀏覽器**: 直接在瀏覽器中打開 `comparison_flow_diagram.svg` 文件
2. **VS Code**: 安裝 SVG Preview 擴展，然後預覽文件
3. **其他工具**: 使用任何支持 SVG 的圖像查看器或編輯器

## 優化建議

### 1. 對齊優化（階段6）
- 增加搜索範圍（例如±90°）
- 使用更細的搜索步長（例如角度1°，平移2px）
- 實現迭代優化機制（多次細化搜索）
- 考慮尺度變化（添加縮放搜索）
- 使用更準確的相似度評估方法

### 2. 相似度計算優化（階段7）
- 根據圖像特性動態調整權重
- 考慮圖像品質差異（例如掃描解析度）
- 實現局部相似度計算（分區域評估）
- 使用自適應閾值（根據圖像特性調整）

### 3. 視覺化優化（階段8）
- 改進背景移除算法（使用更先進的方法）
- 實現自適應參數調整（差異閾值、高斯模糊等）
- 添加視覺化品質指標
- 實現錯誤恢復機制

### 4. 整體流程優化
- 添加錯誤恢復機制（優雅降級）
- 實現進度追蹤和日誌記錄
- 優化性能（並行處理、緩存等）
- 添加單元測試和集成測試

## 相關文件

- `backend/core/seal_compare.py`: 核心比對邏輯
- `backend/core/verification.py`: 驗證視覺化生成
- `backend/core/overlay.py`: 疊圖生成
- `backend/app/services/comparison_service.py`: 比對服務層
- `backend/app/api/comparisons.py`: API端點

## 更新記錄

- 2024-12-XX: 創建初始流程圖

